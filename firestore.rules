/**
 * @file firestore.rules
 * @description Firestore Security Rules for the RSU iLEARN LMS application.
 *
 * @section Core Philosophy
 * This ruleset enforces a strict user-ownership and role-based model tailored for a
 * Learning Management System (LMS). The primary goal is to ensure that users can only
 * access data they own or are explicitly granted permission to view/edit. For example,
 * students control their own profiles and submissions, while teachers control the
 * course materials they create.
 *
 * @section Data Structure
 * The data is structured hierarchically to reflect ownership and relationships clearly.
 * - /users/{userId}: Contains private user profiles.
 * - /users/{userId}/courses/{courseId}: Contains a teacher's master course blueprints.
 * - /users/{userId}/submissions/{submissionId}: Contains a student's private submissions.
 * - /users/{teacherId}/blocks/{blockId}: Contains a teacher's course blocks and all
 *   nested content (assignments, quizzes, questions). This nested structure is critical
 *   for creating simple, performant, and secure rules based on path ownership.
 *
 * @section Key Security Decisions
 * - User Isolation: Users cannot list or view other users' profiles or data trees.
 * - Nested Course Content: To ensure clear ownership, all course materials (assignments,
 *   quizzes, questions) are nested under the teacher who owns them (`/users/{teacherId}/courses/...`).
 *   This avoids complex and insecure rules that would be required with top-level collections.
 * - Teacher Access to Submissions: A teacher is granted read and update access (for grading)
 *   to a student's submission. This is achieved by requiring a denormalized `teacherId`
 *   field on each submission document.
 * - Missing Student Enrollment Logic: The current IR does not define an "enrollment" system.
 *   Therefore, as a secure default, access to all course materials (assignments, quizzes)
 *   is restricted to the owning teacher. Student access will need to be added once an
 *   enrollment model is implemented.
 *
 * @section Denormalization for Authorization
 * To create simpler, more performant rules, we denormalize data required for authorization:
 * - Course/Block Ownership: The `/users/{teacherId}/...` path itself establishes the
 *   teacher's ownership of all nested content, simplifying rules for courses, blocks, assignments and quizzes.
 * - Submission Grading: Each `/submissions/{submissionId}` document must contain a `teacherId`
 *   field. This allows the rules to grant a specific teacher access to grade a student's
 *   work without performing slow, costly, or impossible lookups on other documents.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    /**
     * Returns true if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the requesting user's UID matches the provided userId.
     * This is the primary mechanism for checking resource ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Returns true if the requesting user is the designated teacher for a resource.
     * Checks against a denormalized `teacherId` field on the resource.
     */
    function isTeacher(teacherId) {
      return isSignedIn() && request.auth.uid == teacherId;
    }
    
    /**
     * Enforces immutability for critical relational IDs during an update.
     * Prevents re-assigning a document to a different parent.
     */
    function isImmutable(fieldName) {
      return request.resource.data[fieldName] == resource.data[fieldName];
    }

    // -------------------------------------------------------------------------
    // User Profiles (/users)
    // -------------------------------------------------------------------------

    /**
     * @description Manages user profile documents.
     * @path /users/{userId}
     * @allow A signed-in user (auth.uid=`user_123`) can create, read, or update their own profile at `/users/user_123`.
     * @deny A user (auth.uid=`user_abc`) cannot read or write to `/users/user_xyz`. Listing users is also denied.
     * @principle Restricts access to a user's own data tree and prevents user enumeration.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Prevent listing all users
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) && resource != null && isImmutable('id');
      allow delete: if isOwner(userId) && resource != null;
    }

    // -------------------------------------------------------------------------
    // Teacher-Owned Courses (/users/{teacherId}/courses)
    // -------------------------------------------------------------------------

    /**
     * @description Manages master course blueprints owned by a teacher.
     * @path /users/{teacherId}/courses/{courseId}
     * @allow A teacher (`teacher_123`) can manage course blueprints within their own user space (`/users/teacher_123/...`).
     * @deny Any user who is not the teacher specified in the path cannot access these documents.
     * @principle Enforces strict ownership based on the document's path.
     */
    match /users/{teacherId}/courses/{courseId} {
        // TODO: Add student read access once an enrollment model is defined.
        allow get, list: if isOwner(teacherId);
        allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
        allow update: if isOwner(teacherId) && resource != null && isImmutable('teacherId');
        allow delete: if isOwner(teacherId) && resource != null;
    }

    // -------------------------------------------------------------------------
    // Student Submissions (/users/{userId}/submissions)
    // -------------------------------------------------------------------------

    /**
     * @description Manages student submissions for assignments and quizzes.
     * @path /users/{userId}/submissions/{submissionId}
     * @allow A student (`user_123`) can create or read their own submission.
     * @allow The teacher (`teacher_abc`) can read or update (grade) a student's submission if `resource.data.teacherId == 'teacher_abc'`.
     * @deny A student cannot access another student's submissions. A teacher cannot delete a student's submission.
     * @principle Enforces document ownership for the student, with specific shared access granted to the teacher for grading via a denormalized ID.
     */
    match /users/{userId}/submissions/{submissionId} {
      allow get: if (isOwner(userId) || isTeacher(resource.data.teacherId)) && resource != null;
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if (isOwner(userId) || isTeacher(resource.data.teacherId)) && resource != null && isImmutable('userId');
      allow delete: if isOwner(userId) && resource != null;
    }

    // -------------------------------------------------------------------------
    // Teacher-Owned Blocks (/users/{teacherId}/blocks)
    // -------------------------------------------------------------------------

    /**
     * @description Manages course blocks, which act as containers for course materials.
     * @path /users/{teacherId}/blocks/{blockId}
     * @allow A teacher (`teacher_123`) can create, read, update, or delete a block within their own user space (`/users/teacher_123/...`).
     * @deny Any user who is not the teacher specified in the path cannot access these documents.
     * @principle Enforces strict ownership based on the document's path. The teacher owns the entire data tree below this point.
     */
    match /users/{teacherId}/blocks/{blockId} {
      // TODO: Add student read access once an enrollment model is defined.
      // e.g., `|| isStudentEnrolledInBlock(blockId)`
      allow get, list, create, update, delete: if isOwner(teacherId);
    }

    // -------------------------------------------------------------------------
    // Assignments (/users/{teacherId}/blocks/{blockId}/assignments)
    // -------------------------------------------------------------------------

    /**
     * @description Manages assignments within a teacher's block.
     * @path /users/{teacherId}/blocks/{blockId}/assignments/{assignmentId}
     * @allow A teacher (`teacher_123`) can manage assignments under their own block.
     * @deny Any other user, including students, cannot currently access assignments directly.
     * @principle Inherits ownership from the parent block's path. Access is restricted to the teacher.
     */
    match /users/{teacherId}/blocks/{blockId}/assignments/{assignmentId} {
      // TODO: Add student read access once an enrollment model is defined.
      allow get, list: if isOwner(teacherId);
      allow create: if isOwner(teacherId) && request.resource.data.blockId == blockId;
      allow update: if isOwner(teacherId) && resource != null && isImmutable('blockId');
      allow delete: if isOwner(teacherId) && resource != null;
    }

    // -------------------------------------------------------------------------
    // Quizzes (/users/{teacherId}/blocks/{blockId}/quizzes)
    // -------------------------------------------------------------------------

    /**
     * @description Manages quizzes within a teacher's block.
     * @path /users/{teacherId}/blocks/{blockId}/quizzes/{quizId}
     * @allow A teacher (`teacher_123`) can manage quizzes under their own block.
     * @deny Any other user, including students, cannot currently access quizzes directly.
     * @principle Inherits ownership from the parent block's path. Access is restricted to the teacher.
     */
    match /users/{teacherId}/blocks/{blockId}/quizzes/{quizId} {
      // TODO: Add student read access once an enrollment model is defined.
      allow get, list: if isOwner(teacherId);
      allow create: if isOwner(teacherId) && request.resource.data.blockId == blockId;
      allow update: if isOwner(teacherId) && resource != null && isImmutable('blockId');
      allow delete: if isOwner(teacherId) && resource != null;
    }

    // -------------------------------------------------------------------------
    // Questions (/users/{teacherId}/blocks/{blockId}/quizzes/{quizId}/questions)
    // -------------------------------------------------------------------------

    /**
     * @description Manages questions within a quiz. Contains sensitive data like correct answers.
     * @path /users/{teacherId}/blocks/{blockId}/quizzes/{quizId}/questions/{questionId}
     * @allow A teacher (`teacher_123`) can manage questions for a quiz they own.
     * @deny Students cannot access questions, protecting the integrity of quizzes.
     * @principle Inherits ownership from the parent quiz path, ensuring only the course creator can manage sensitive quiz data.
     */
    match /users/{teacherId}/blocks/{blockId}/quizzes/{quizId}/questions/{questionId} {
      // NOTE: Access is restricted to the teacher only to protect correct answers.
      // A separate "published" or student-facing data structure might be needed to
      // deliver quizzes without exposing answers.
      allow get, list, create, update, delete: if isOwner(teacherId);
    }
  }
}
